import bcrypt
import time
from email.message import EmailMessage
import random
import smtplib


#"banco de dados" utilizado apenas até o banco sql real
tabela = 'meu_fazendao'

class Usuario:
    def __init__(self, email, senha, nome):
        self.email = email
        self.senha = senha
        self.nome = nome
    
    def get_email(self): return self.email
    def get_senha(self): return self.senha
    def get_nome(self): return self.nome

    def verific_senha(self,senha_correta, email, tabela):
        cont = 2
        timer = 10
       
        while True:
            while True:
                try:
                    pergunta = int(input("Digitar senha (0)\nEsqueci minha senha (1)\nResposta: "))
                    while pergunta != 0 and pergunta != 1: int(input("Valor Inválido\n\nDigitar senha (0)\nEsqueci minha senha (1)\nResposta: "))
                    break
                except ValueError:print("valor Inválido")
           
            if pergunta == 0:
                while cont >= 0:
                    senha = input("Por favor digite a senha: ").encode()
                    if bcrypt.checkpw(senha, senha_correta.encode()):
                        print("senha correta")
                        return senha
                    else:
                        print(f"senha incorreta, vc tem mais {cont} chances: ")




                    cont -= 1
           
                print("Conta bloqueada temporariamente")
                timer += 20
                time.sleep(timer)
            else:
                cont2 = 2
                codigo = random.randint(10000000,99999999)
                codigo_c = codigo
                enviar_email(email,"Redefinir Senha",f"Abaixo segue o codigo para realizar a alteração da senha\n{codigo_c}")
                while cont2 >= 0:
                    codigoen = int(input("Por favor digite o codigo de verificação enviado no email cadastrado: "))
                    if codigo_c == codigoen:
                        print("senha correta")
                        nova_senha = input("Digite a nova senha: ").encode()


                        with open(f"{tabela}", "r") as arquivo:
                                linhas = arquivo.readlines()
                        with open(f"{tabela}.txt", "w") as arquivo:
                                    for linha in linhas:
                                        partes = linha.strip().split(" : ")
                                        if len(partes) == 3 and partes[2] == email:
                                            arquivo.write(f"{self.nome} : {email} : {nova_senha.decode()}\n")
                                        else:
                                            arquivo.write(linha)
                        return senha
                    else:
                        print(f"senha incorreta, vc tem mais {cont2} chances: ")




                    cont2 -= 1
           
                print("Conta bloqueada temporariamente")
                timer += 20
                time.sleep(timer)

def enviar_email(destinatario, assunto, corpo):
    email_remetente = 'meu_fazendao@gmail.com'
    senha = 'cytv hbkx rfac mnbw'  # Sua senha de app gerada no Google


    # Criar mensagem
    msg = EmailMessage()
    msg['Subject'] = assunto
    msg['From'] = email_remetente
    msg['To'] = destinatario
    msg.set_content(corpo)  # Corpo em texto puro


    # Enviar e-mail pelo servidor SMTP do Gmail
    with smtplib.SMTP_SSL('smtp.gmail.com', 465) as smtp:
        smtp.login(email_remetente, senha)
        smtp.send_message(msg)
        print("Email enviado com sucesso!")

#função para verificar se há cadastro do usuario no banco
def ver_cadas(email, tabela):      
            existe = False
            #procura no banco se os dados já existem
            with open(f"{tabela}.txt", "r") as arquivo:
                linhas = arquivo.readlines()
                for linha in linhas:
                    partes = linha.strip().split(" : ")
                    if len(partes) == 3 and partes[1] == email:
                        existe = True
                        break

            if existe: return True
            else: return False
              

email = input('Por favor, Digite seu email: ')
if not ver_cadas(email, tabela):
    senha = input("Cadastre Sua Senha: ").encode()
    senha = bcrypt.hashpw(senha, bcrypt.gensalt()).decode()
    nome = input('Por favor, Digite seu nome completo: ')

    with open(f"{tabela}.txt", "a") as arquivo:
            arquivo.write(f"{nome} : {email} : {senha}\n")
    
    usuario1 = Usuario(email, senha, nome)
else:
    print('email Já cadastrado\nLogin')
    with open(f"{tabela}.txt", "r") as arquivo:
        linhas = arquivo.readlines()
        for linha in linhas:
            partes = linha.strip().split(" : ")
            if len(partes) == 3 and partes[1] == email:
                senha_correta = partes[2]
                nome = partes[0]
    usuario1 = Usuario(email, senha_correta, nome)
    usuario1.verific_senha(senha_correta, email, tabela)
